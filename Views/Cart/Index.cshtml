@model IEnumerable<PawVerse.Models.GioHangChiTiet>

@{
    ViewData["Title"] = "Giỏ hàng";
    decimal tongTien = Model.Sum(item => item.ThanhTien);
}

<div class="container cart-page">
    <h2 class="mb-4">Giỏ hàng của bạn</h2>
    
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger">
            @TempData["ErrorMessage"]
        </div>
    }
    
    @if (!Model.Any())
    {
        <div class="empty-cart text-center">
            <i class="fas fa-shopping-cart"></i>
            <h3>Giỏ hàng của bạn đang trống</h3>
            <p class="text-muted mb-4">Hãy khám phá các sản phẩm và thêm vào giỏ hàng của bạn</p>
            <a href="/" class="btn btn-primary px-4">Tiếp tục mua sắm</a>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-lg-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table cart-table mb-0">
                                <thead>
                                    <tr>
                                        <th>Sản phẩm</th>
                                        <th class="text-center">Đơn giá</th>
                                        <th class="text-center">Số lượng</th>
                                        <th class="text-end">Thành tiền</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model)
                                    {
                                        <tr>
                                            <td data-label="Sản phẩm">
                                                <div class="product-info">
                                                    <img src="@(item.SanPham.HinhAnh ?? "/images/no-image.png")" 
                                                         alt="@item.SanPham.TenSanPham" 
                                                         class="img-thumbnail">
                                                    <div class="product-details">
                                                        <h5>@item.SanPham.TenSanPham</h5>
                                                        @if (item.SanPham.IdThuongHieuNavigation != null)
                                                        {
                                                            <p>@item.SanPham.IdThuongHieuNavigation.TenThuongHieu</p>
                                                        }
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="text-center" data-label="Đơn giá">
                                                @if (item.SanPham.GiaKhuyenMai.HasValue && item.SanPham.GiaKhuyenMai < item.SanPham.GiaBan)
                                                {
                                                    <div class="text-danger fw-bold">@item.SanPham.GiaKhuyenMai.Value.ToString("N0") ₫</div>
                                                    <div class="text-muted text-decoration-line-through small">@item.SanPham.GiaBan.ToString("N0") ₫</div>
                                                }
                                                else
                                                {
                                                    <div class="fw-bold">@item.SanPham.GiaBan.ToString("N0") ₫</div>
                                                }
                                            </td>
                                            <td class="text-center" data-label="Số lượng">
                                                <div class="quantity-control">
                                                    <button class="quantity-btn btn-decrease" data-id="@item.Id">-</button>
                                                    <input type="number" class="quantity-input" 
                                                           value="@item.SoLuong" min="1" max="@item.SanPham.SoLuongTonKho" 
                                                           data-id="@item.Id">
                                                    <button class="quantity-btn btn-increase" data-id="@item.Id">+</button>
                                                </div>
                                                <div class="small text-muted mt-1">Còn lại: @item.SanPham.SoLuongTonKho</div>
                                            </td>
                                            <td class="text-end fw-bold" data-label="Thành tiền">
                                                @{
                                                    var price = item.SanPham.GiaKhuyenMai ?? item.SanPham.GiaBan;
                                                    var total = price * item.SoLuong;
                                                }
                                                @total.ToString("N0") ₫
                                            </td>
                                            <td class="text-center" data-label="">
                                                <a href="#" class="remove-item btn-remove" data-id="@item.Id">
                                                    <i class="fas fa-times"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-between mb-4">
                    <a href="/" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Tiếp tục mua sắm
                    </a>
                    <button class="btn btn-outline-danger" id="btn-clear-cart">
                        <i class="fas fa-trash me-2"></i>Xóa tất cả
                    </button>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="cart-summary">
                    <h4>Tóm tắt đơn hàng</h4>
                    <div class="summary-row">
                        <span>Tạm tính (@Model.Sum(i => i.SoLuong) sản phẩm)</span>
                        <span>@Model.Sum(i => (i.SanPham.GiaKhuyenMai ?? i.SanPham.GiaBan) * i.SoLuong).ToString("N0") ₫</span>
                    </div>
                    <div class="summary-row">
                        <span>Phí vận chuyển</span>
                        <span class="text-success">Miễn phí</span>
                    </div>
                    <div class="summary-row total">
                        <span>Tổng cộng</span>
                        <span class="text-primary">@Model.Sum(i => (i.SanPham.GiaKhuyenMai ?? i.SanPham.GiaBan) * i.SoLuong).ToString("N0") ₫</span>
                    </div>
                    <a href="@Url.Action("Checkout", "Order")" class="btn btn-primary w-100 py-3 mt-4" id="btn-checkout">
                        <i class="fas fa-credit-card me-2"></i>Tiến hành thanh toán
                    </a>
                    <div id="debug-info" class="mt-2 small text-danger"></div>
                    <p class="small text-muted mt-2 mb-0">
                        <i class="fas fa-lock me-1"></i>
                        Thông tin thanh toán được bảo mật
                    </p>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Xử lý tăng số lượng
            $(document).on('click', '.btn-increase', function(e) {
                e.preventDefault();
                const itemId = $(this).data('id');
                const $input = $(`input[data-id="${itemId}"]`);
                const max = parseInt($input.attr('max'));
                let quantity = parseInt($input.val());
                
                if (quantity < max) {
                    quantity += 1;
                    $input.val(quantity).trigger('change');
                    updateCartItem(itemId, quantity);
                } else {
                    alert('Số lượng sản phẩm đã đạt tối đa trong kho');
                }
            });
            
            // Xử lý giảm số lượng
            $(document).on('click', '.btn-decrease', function(e) {
                e.preventDefault();
                const itemId = $(this).data('id');
                const $input = $(`input[data-id="${itemId}"]`);
                let quantity = parseInt($input.val());
                
                if (quantity > 1) {
                    quantity -= 1;
                    $input.val(quantity).trigger('change');
                    updateCartItem(itemId, quantity);
                }
            });
            
            // Xử lý cập nhật số lượng khi người dùng nhập trực tiếp
            $(document).on('change', '.quantity-input', function() {
                const itemId = $(this).data('id');
                const max = parseInt($(this).attr('max'));
                let quantity = parseInt($(this).val());
                
                if (isNaN(quantity) || quantity < 1) {
                    quantity = 1;
                    $(this).val(1);
                } else if (quantity > max) {
                    quantity = max;
                    $(this).val(max);
                    alert('Số lượng sản phẩm vượt quá số lượng trong kho');
                }
                
                updateCartItem(itemId, quantity);
            });
            
            // Xử lý xóa sản phẩm
            $(document).on('click', '.btn-remove', function(e) {
                e.preventDefault();
                const itemId = $(this).data('id');
                
                if (confirm('Bạn có chắc chắn muốn xóa sản phẩm này khỏi giỏ hàng?')) {
                    removeFromCart(itemId);
                }
            });
            
            // Xử lý xóa tất cả sản phẩm
            $('#btn-clear-cart').on('click', function() {
                if (confirm('Bạn có chắc chắn muốn xóa tất cả sản phẩm khỏi giỏ hàng?')) {
                    clearCart();
                }
            });

            // Debug nút thanh toán
            $('#btn-checkout').on('click', function(e) {
                console.log('Nút thanh toán được nhấn');
                const url = $(this).attr('href');
                console.log('URL thanh toán:', url);
                
                // Kiểm tra xem có sản phẩm trong giỏ hàng không
                const cartItemCount = @Model.Count();
                console.log('Số sản phẩm trong giỏ:', cartItemCount);
                
                if (cartItemCount === 0) {
                    e.preventDefault();
                    $('#debug-info').text('Không có sản phẩm nào trong giỏ hàng');
                    console.error('Không thể thanh toán: Giỏ hàng trống');
                    return false;
                }
                
                // Kiểm tra đăng nhập (nếu cần)
                // Nếu cần đăng nhập, có thể kiểm tra ở đây và chuyển hướng đến trang đăng nhập
                
                console.log('Đang chuyển hướng đến trang thanh toán...');
                return true; // Cho phép chuyển hướng
            });
            
            // Hàm cập nhật số lượng sản phẩm
            function updateCartItem(itemId, quantity) {
                $.ajax({
                    url: '/Cart/UpdateCartItem',
                    type: 'POST',
                    data: {
                        itemId: itemId,
                        quantity: quantity
                    },
                    success: function(response) {
                        if (response.success) {
                            updateCartCount();
                            // Tải lại trang để cập nhật tổng tiền
                            location.reload();
                        } else {
                            alert(response.message || 'Có lỗi xảy ra khi cập nhật giỏ hàng');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error:', error);
                        alert('Có lỗi xảy ra khi kết nối đến máy chủ');
                    }
                });
            }
            
            // Hàm xóa sản phẩm khỏi giỏ hàng
            function removeFromCart(itemId) {
                $.ajax({
                    url: '/Cart/RemoveFromCart',
                    type: 'POST',
                    data: { itemId: itemId },
                    success: function(response) {
                        if (response.success) {
                            updateCartCount();
                            // Tải lại trang để cập nhật giỏ hàng
                            location.reload();
                        } else {
                            alert('Có lỗi xảy ra khi xóa sản phẩm');
                        }
                    },
                    error: function() {
                        alert('Có lỗi xảy ra khi kết nối đến máy chủ');
                    }
                });
            }
            
            // Cập nhật số lượng sản phẩm trên giỏ hàng
            function updateCartCount() {
                $.get('/Cart/GetCartCount', function(data) {
                    const $cartCount = $('.cart-count');
                    if ($cartCount.length) {
                        $cartCount.text(data.count);
                    }
                });
            }
            
            // Hàm xóa tất cả sản phẩm khỏi giỏ hàng
            function clearCart() {
                $.ajax({
                    url: '/Cart/ClearCart',
                    type: 'POST',
                    success: function(response) {
                        if (response.success) {
                            updateCartCount();
                            // Tải lại trang để cập nhật giỏ hàng
                            location.reload();
                        } else {
                            alert(response.message || 'Có lỗi xảy ra khi xóa giỏ hàng');
                        }
                    },
                    error: function() {
                        alert('Có lỗi xảy ra khi kết nối đến máy chủ');
                    }
                });
            }
        });
    </script>
}
